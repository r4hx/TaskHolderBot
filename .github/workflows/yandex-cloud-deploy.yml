name: Yandex.Cloud CI
on: push
jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@v3
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.7'
        architecture: 'x64'
      - name: Install Flake8
        run: python3 -m pip install flake8
      - name: Lint main folder
        run: python3 -m flake8 *
      - name: Lint tests
        run: python3 -m flake8 tests/*
  testing:
    needs: [linting]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@master
    - name: Install Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.7'
        architecture: 'x64'
      - name: Installing dependencies
        run: python3 -m pip install -r requirements.txt
      - name: Discovering test
        run: python3 -m unittest discover -v tests/
  deploy:
    needs: [linting, testing]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@master
      - name: push code to yandex functions
        uses: goodsmileduck/yandex-serverless-action@master
        with:
          token: ${{ secrets.YC_TOKEN }}
          function_id: ${{ secrets.YC_FUNCTION_ID }}
          runtime: 'python37-preview'
          entrypoint: 'main.handler'
          environment: DEBUG=True,USER_ACCESS_ID=${{ secrets.SERVICE_USER_ACCESS_ID }},USER_ACCESS_SECRET=${{ secrets.SERVICE_USER_ACCESS_SECRET }},BUCKET=${{ secrets.YC_BUCKET }}
          source: '.'